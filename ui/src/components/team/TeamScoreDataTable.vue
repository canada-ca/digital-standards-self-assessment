<template>
  <div class="table-wrapper">
    <b-table
      :striped="true"
      :bordered="true"
      :hover="true"
      head-variant="dark"
      :items="items"
      :fields="fields"
      :sort-by.sync="sortBy"
      :sort-desc.sync="sortDesc"
      responsive="sm"
    >
      <template #cell(team_name)="row">
        <b-link
          class="team-name"
          v-b-tooltip.hover
          :title="$t('teamResults.showIndividualBreakdown')"
          @click.prevent="showIndividualBreakdown(row)"
        >
          {{ row.item.team_name }}
        </b-link>
      </template>
      <template #cell(actions)="row">
        <b-link
          class="delete-team"
          @click.prevent="deleteTeam(row)"
          v-b-tooltip.hover
          :title="$t('teamResults.deleteTeam')"
        >
          <b-icon-trash style="margin-right: 10px" class="action-icon" />
        </b-link>
      </template>
    </b-table>
    <div style="font-size: 12px" v-html="markdownToHtml($t('teamResults.showIndividualBreakdownInstruction'))" />
  </div>
</template>

<script lang="ts">
import { TeamReportData } from '@/store/state';
import { Component, Prop, Vue, Watch } from 'vue-property-decorator';
import { BIconTrash } from 'bootstrap-vue';
import { ActionTypes } from '@/store/actions';
import { marked } from 'marked';
import i18n from '@/plugins/i18n';

@Component({
  components: {
    BIconTrash,
  },
})
export default class TeamScoreDataTable extends Vue {
  @Prop()
  teamReportDataArray!: Array<TeamReportData>;

  sortBy = 'team_name';
  sortDesc = false;
  fields = [{ key: 'team_name', sortable: true }] as any[];

  items: any[] = [];

  private extractAllSectionNames() {
    const sectionNameSet: Set<string> = new Set();
    this.teamReportDataArray.forEach((t) => {
      t.sections.forEach((s) => {
        sectionNameSet.add(s.name);
      });
    });
    const sectionNames = [...sectionNameSet];
    sectionNames.sort((a, b) => (a > b ? 1 : a < b ? -1 : 0));
    this.fields = [
      {
        key: 'team_name',
        sortable: true,
        label: i18n.t('teamResults.teamName'),
      },
    ];
    sectionNames.map((sectionName) => {
      this.fields.push({ key: sectionName, sortable: true });
    });
    this.fields.push({
      key: 'actions',
      sortable: false,
      tdClass: 'text-center',
      label: i18n.t('teamResults.actions'),
    });
    return sectionNames;
  }

  private getTeamScores(sectionNames: string[]) {
    this.items = [];
    this.teamReportDataArray.forEach((data) => {
      var rec: { [k: string]: any } = {};
      rec['teamId'] = data.teamId;
      rec['team_name'] = this.$i18n.locale === 'fr' ? data.team.teamNameFr : data.team.teamNameEn;
      sectionNames.forEach((sn) => {
        // eslint-disable-next-line security/detect-object-injection
        rec[sn] = this.getSectionScore(data.teamId, sn) + '%';
      });
      this.items.push(rec);
      this.items.sort((a, b) => (a['team_name'] > b['team_name'] ? 1 : a['team_name'] < b['team_name'] ? -1 : 0));
    });
  }

  private getSectionScore(teamId: string, sectionName: string): string {
    let scorePercentage = '0';
    if (this.teamReportDataArray) {
      const teamReportData = this.teamReportDataArray.find((t) => t.teamId === teamId);
      if (teamReportData) {
        const section = teamReportData.sections.find((s) => s.name === sectionName);
        if (section) {
          scorePercentage = new Intl.NumberFormat('en-CA', {
            style: 'decimal',
            maximumFractionDigits: 0,
          }).format((section.score / section.maxScore) * 100);
          if (scorePercentage === 'NaN') {
            return '0';
          }
        }
      }
    }
    return scorePercentage;
  }

  created() {
    this.createDatatable();
  }

  @Watch('teamReportDataArray')
  @Watch('$i18n.locale')
  createDatatable() {
    const sectionNames = this.extractAllSectionNames();
    this.getTeamScores(sectionNames);
  }

  deleteTeam(row: any) {
    this.$store.commit(ActionTypes.DeleteTeamSurvey, row.item.teamId);
  }

  showIndividualBreakdown(row: any) {
    this.$store.commit(ActionTypes.ShowIndividualBreakdown, row.item.teamId);
  }

  markdownToHtml(item: string) {
    return marked(item);
  }
}
</script>

<style scoped>
.action-icon {
  cursor: pointer;
  user-select: none;
}
.team-name {
  cursor: pointer;
}
.delete-team {
  text-decoration: none !important;
}
.table-wrapper {
  overflow: auto;
  max-height: 500px;
}
</style>
